<!DOCTYPE html>
<html lang="en">

<script>
    function includeHTML() {
        var z, i, elmnt, file, xhttp;
        /*loop through a collection of all HTML elements:*/
        z = document.getElementsByTagName("*");
        for (i = 0; i < z.length; i++) {
            elmnt = z[i];
            /*search for elements with a certain attribute:*/
            file = elmnt.getAttribute("nav-bar");
            if (file) {
                /*make an HTTP request using the attribute value as the file name:*/
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) { elmnt.innerHTML = this.responseText; }
                        if (this.status == 404) { elmnt.innerHTML = "Page not found."; }
                        /*remove the attribute, and call this function once more:*/
                        elmnt.removeAttribute("nav-bar");
                        includeHTML();
                    }
                }
                xhttp.open("GET", file, true);
                xhttp.send();
                /*exit the function:*/
                return;
            }
        }
    };
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zeber</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css?v=9">
    <script src="nav.js"></script>
</head>

<body>
    <div nav-bar="nav_bar.html"></div>

    <div class="content-container" style="margin-top: 70px;">
        <div id="menuItems">
            <div class="menu-item" data-price="10">
                <img class="item-img" src="zeber-bottle-cropped-01.png" alt="Zeber beer bottle">
                <div class="item-info">
                    <span class="item-name">Beer Delivery</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num1', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num1">0</span>
                    <input type="hidden" id="num1" value="0">
                    <button class="stepper-btn" onclick="adjust('num1', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="10">
                <img class="item-img" src="order_files/chips_and_guacamole.jpg" alt="chips">
                <div class="item-info">
                    <span class="item-name">Chips</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num2', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num2">0</span>
                    <input type="hidden" id="num2" value="0">
                    <button class="stepper-btn" onclick="adjust('num2', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="5">
                <img class="item-img" src="order_files/chair.jpg" alt="folding chair">
                <div class="item-info">
                    <span class="item-name">Chair Moving Services</span>
                    <span class="item-price">5&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num3', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num3">0</span>
                    <input type="hidden" id="num3" value="0">
                    <button class="stepper-btn" onclick="adjust('num3', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="15">
                <img class="item-img" src="order_files/hammock.jpeg" alt="hammock">
                <div class="item-info">
                    <span class="item-name">Hammock Rental</span>
                    <span class="item-price">15&#162; / hr</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num4', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num4">0</span>
                    <input type="hidden" id="num4" value="0">
                    <button class="stepper-btn" onclick="adjust('num4', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="10">
                <img class="item-img" src="order_files/redball_poster.jpg" alt="redball entertainment">
                <div class="item-info">
                    <span class="item-name">Redball Tickets</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num5', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num5">0</span>
                    <input type="hidden" id="num5" value="0">
                    <button class="stepper-btn" onclick="adjust('num5', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="10">
                <img class="item-img" src="order_files/trophy-on-field-under-stadium-lights-at-night-photo.jpg" alt="redball tournament trophy">
                <div class="item-info">
                    <span class="item-name">Redball Tournament</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num6', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num6">0</span>
                    <input type="hidden" id="num6" value="0">
                    <button class="stepper-btn" onclick="adjust('num6', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="1500">
                <img class="item-img" src="order_files/zeber-shirt-model.png" alt="Zeber t-shirt">
                <div class="item-info">
                    <span class="item-name">T-Shirt</span>
                    <span class="item-price">$15.00</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num7', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num7">0</span>
                    <input type="hidden" id="num7" value="0">
                    <button class="stepper-btn" onclick="adjust('num7', 1)">+</button>
                </div>
            </div>
            <div class="menu-item" data-price="15">
                <img class="item-img" src="order_files/cowbell.png" alt="Cowbell">
                <div class="item-info">
                    <span class="item-name">Cowbell Rental</span>
                    <span class="item-price">15&#162; / hr</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num8', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num8">0</span>
                    <input type="hidden" id="num8" value="0">
                    <button class="stepper-btn" onclick="adjust('num8', 1)">+</button>
                </div>
            </div>        </div>
    </div>

    <!-- Sticky order footer -->
    <div class="order-footer">
        <button id="personBtn" class="person-btn" onclick="openNameDialog()">&#128100; <span id="personDisplay">Tap to set name</span></button>
        <input type="hidden" id="personID" value="">
        <span class="footer-total" id="totalDisplay">0&#162;</span>
        <button id="submitBtn" class="submit-btn" onclick="submitOrder()">Submit Order</button>
    </div>

    <!-- Name dialog -->
    <div id="nameDialogBg" class="dialog-bg" onclick="nameDialogBgClick(event)">
        <div class="dialog-box" id="nameDialogBox">
            <p class="dialog-title">&#128075; What&#8217;s your name?</p>
            <p class="dialog-sub">We&#8217;ll remember you for next time.</p>
            <input id="nameInput" class="dialog-input" type="text" placeholder="Enter your name" autocomplete="off" autocorrect="off" spellcheck="false">
            <div class="dialog-actions">
                <button class="dialog-btn dialog-btn-primary" onclick="confirmName()">Save</button>
                <button class="dialog-btn dialog-btn-secondary" id="cancelNameBtn" onclick="closeNameDialog()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- T-shirt size picker dialog -->
    <div id="sizePickerBg" class="dialog-bg">
        <div class="dialog-box">
            <p class="dialog-title">&#128085; Choose shirt size(s)</p>
            <p class="dialog-sub">Ordering <strong id="sizeOrderQty">0</strong> shirt(s) &mdash; allocate sizes below.</p>
            <div id="sizeOptions"></div>
            <p class="size-remaining">Still to allocate: <strong id="sizeRemaining">0</strong></p>
            <div class="dialog-actions">
                <button id="sizeConfirmBtn" class="dialog-btn dialog-btn-primary" onclick="confirmSizes()" disabled>Confirm</button>
                <button class="dialog-btn dialog-btn-secondary" onclick="closeSizePicker()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="output"></div>

    <!-- Lightbox -->
    <div id="lightbox" onclick="lightboxBgClick(event)">
        <button class="lightbox-close" onclick="closeLightbox()">&#x2715;</button>
        <div id="lightbox-inner" onclick="lightboxBgClick(event)">
            <img id="lightbox-img" onclick="toggleZoom()" src="" alt="">
        </div>
    </div>

    <script>
        includeHTML();

        // Attach lightbox to all item images after page loads
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.item-img').forEach(function (img) {
                img.addEventListener('click', function () { openLightbox(this); });
            });
        });

        function openLightbox(img) {
            var lb = document.getElementById('lightbox');
            var lbImg = document.getElementById('lightbox-img');
            lbImg.src = img.src;
            lbImg.alt = img.alt;
            lbImg.classList.remove('zoomed');
            lb.classList.add('active');
            lb.scrollTop = 0;
            lb.scrollLeft = 0;
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        function lightboxBgClick(e) {
            if (e.target.id === 'lightbox' || e.target.id === 'lightbox-inner') {
                closeLightbox();
            }
        }

        function toggleZoom() {
            document.getElementById('lightbox-img').classList.toggle('zoomed');
        }

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeLightbox();
                closeNameDialog(); // will no-op if no name saved
                closeSizePicker();
            }
            if (e.key === 'Enter' && document.getElementById('nameDialogBg').classList.contains('active')) {
                confirmName();
            }
        });

        function setCookie(name, value) {
            document.cookie = `${name}=${encodeURIComponent(value)}; path=/`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            for (const cookie of cookies) {
                const [cookieName, cookieValue] = cookie.split('=');
                if (cookieName === name) return decodeURIComponent(cookieValue || '');
            }
            return null;
        }

        window.onload = function () {
            const saved = getCookie('personID');
            if (saved) setPersonName(saved);
            // Name is no longer auto-prompted — user sets it at submit time
        };
        window.onload();

        function setPersonName(name) {
            document.getElementById('personID').value = name;
            document.getElementById('personDisplay').textContent = name;
        }

        function openNameDialog() {
            var saved = document.getElementById('personID').value;
            document.getElementById('nameInput').value = saved || '';
            document.getElementById('nameInput').classList.remove('shake');
            document.getElementById('cancelNameBtn').style.display = saved ? '' : 'none';
            document.getElementById('nameDialogBg').classList.add('active');
            setTimeout(function () {
                document.getElementById('nameInput').focus();
            }, 50);
        }

        function closeNameDialog() {
            // Only allow closing if a name is already saved
            if (!document.getElementById('personID').value.trim()) return;
            document.getElementById('nameDialogBg').classList.remove('active');
        }

        function confirmName() {
            var name = document.getElementById('nameInput').value.trim();
            if (!name) {
                var input = document.getElementById('nameInput');
                input.classList.remove('shake');
                void input.offsetWidth;
                input.classList.add('shake');
                input.focus();
                return;
            }
            setPersonName(name);
            setCookie('personID', name);
            document.getElementById('nameDialogBg').classList.remove('active');
            if (_submitPending) {
                _submitPending = false;
                proceedWithOrder();
            }
        }

        function nameDialogBgClick(e) {
            if (e.target.id === 'nameDialogBg') closeNameDialog();
        }

        function adjust(id, delta) {
            var input = document.getElementById(id);
            var newVal = Math.max(0, parseInt(input.value) + delta);
            input.value = newVal;
            document.getElementById('qty_' + id).textContent = newVal;
            input.closest('.menu-item').classList.toggle('selected', newVal > 0);
            updateTotal();
        }

        function updateTotal() {
            var total = 0;
            document.querySelectorAll('#menuItems .menu-item').forEach(function (item) {
                var qty = parseInt(item.querySelector('input[type="hidden"]').value);
                var price = parseInt(item.dataset.price);
                total += qty * price;
            });
            var display = document.getElementById('totalDisplay');
            if (total === 0) {
                display.textContent = '0\u00A2';
            } else if (total < 100) {
                display.textContent = total + '\u00A2';
            } else {
                display.textContent = '$' + (total / 100).toFixed(2);
            }
        }

        // ── Submit flow ──────────────────────────────────────────────────
        var _submitPending = false;
        var _sizeSelections = { S: 0, M: 0, L: 0, XL: 0 };
        var _inventory      = {};
        var _tshirtOrderQty = 0;
        var SUPABASE_URL      = 'https://dpsmpuigeadjpjodbvcq.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc21wdWlnZWFkanBqb2RidmNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTI0NTksImV4cCI6MjA4NzM2ODQ1OX0.aki7zue7xfSfldOkua6KBNM3fZtr0xc4p7qmHgVsdDc';

        function submitOrder() {
            if (!document.getElementById('personID').value.trim()) {
                _submitPending = true;
                openNameDialog();
                return;
            }
            proceedWithOrder();
        }

        function proceedWithOrder() {
            var tshirtQty = parseInt(document.getElementById('num7').value) || 0;
            if (tshirtQty > 0) {
                openSizePicker(tshirtQty);
            } else {
                doSubmit(null);
            }
        }

        // ── Size picker ──────────────────────────────────────────────────
        async function openSizePicker(qty) {
            _tshirtOrderQty = qty;
            _sizeSelections = { S: 0, M: 0, L: 0, XL: 0 };
            document.getElementById('sizeOrderQty').textContent = qty;

            try {
                var resp = await fetch(
                    SUPABASE_URL + '/rest/v1/tshirt_inventory?select=size,quantity_available&order=id',
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY } }
                );
                var rows = await resp.json();
                _inventory = {};
                for (var row of rows) _inventory[row.size] = row.quantity_available;
            } catch (e) {
                _inventory = { S: 99, M: 99, L: 99, XL: 99 };
            }

            var container = document.getElementById('sizeOptions');
            container.innerHTML = '';
            ['S', 'M', 'L', 'XL'].forEach(function(size) {
                var avail  = _inventory[size] || 0;
                var soldout = avail === 0;
                var div = document.createElement('div');
                div.className = 'size-option' + (soldout ? ' soldout' : '');
                div.id = 'sizeOpt_' + size;
                div.innerHTML =
                    '<div class="size-label">'
                        + '<span class="size-name">' + size + '</span>'
                        + '<span class="size-stock">' + (soldout ? 'Sold out' : avail + ' available') + '</span>'
                    + '</div>'
                    + '<div class="item-stepper">'
                        + '<button class="stepper-btn" onclick="adjustSize(\'' + size + '\', -1)"' + (soldout ? ' disabled' : '') + '>&#x2212;</button>'
                        + '<span class="stepper-qty" id="sizeQty_' + size + '">0</span>'
                        + '<button class="stepper-btn" onclick="adjustSize(\'' + size + '\', 1)"' + (soldout ? ' disabled' : '') + '>+</button>'
                    + '</div>';
                container.appendChild(div);
            });

            updateSizeRemaining();
            document.getElementById('sizePickerBg').classList.add('active');
        }

        function adjustSize(size, delta) {
            var avail   = _inventory[size] || 0;
            var current = _sizeSelections[size] || 0;
            var total   = Object.values(_sizeSelections).reduce(function(a,b){return a+b;}, 0);
            var newVal  = current + delta;
            if (newVal < 0) return;
            if (newVal > avail) return;
            if (delta > 0 && total >= _tshirtOrderQty) return;
            _sizeSelections[size] = newVal;
            document.getElementById('sizeQty_' + size).textContent = newVal;
            updateSizeRemaining();
        }

        function updateSizeRemaining() {
            var total = Object.values(_sizeSelections).reduce(function(a,b){return a+b;}, 0);
            var rem = _tshirtOrderQty - total;
            document.getElementById('sizeRemaining').textContent = rem;
            document.getElementById('sizeConfirmBtn').disabled = (rem !== 0);
        }

        function closeSizePicker() {
            document.getElementById('sizePickerBg').classList.remove('active');
        }

        function confirmSizes() {
            var total = Object.values(_sizeSelections).reduce(function(a,b){return a+b;}, 0);
            if (total !== _tshirtOrderQty) return;
            closeSizePicker();
            doSubmit(_sizeSelections);
        }

        // ── Actual network submit ────────────────────────────────────────
        function doSubmit(sizes) {
            setCookie('personID', document.getElementById('personID').value);
            document.getElementById('output').innerText = '';
            document.getElementById('submitBtn').textContent = 'Submitting\u2026';
            document.getElementById('submitBtn').disabled = true;

            var inputs = document.querySelectorAll('#menuItems input[type="hidden"]');
            var out_str = '?';
            for (var i = 0; i < inputs.length; i++) {
                out_str += 'item' + (i + 1) + '=' + inputs[i].value + '&';
            }
            out_str += 'person=' + encodeURIComponent(document.getElementById('personID').value);
            if (sizes) {
                out_str += '&tshirt_s='  + (sizes.S  || 0);
                out_str += '&tshirt_m='  + (sizes.M  || 0);
                out_str += '&tshirt_l='  + (sizes.L  || 0);
                out_str += '&tshirt_xl=' + (sizes.XL || 0);
            }

            var supabaseFunctionURL = 'https://dpsmpuigeadjpjodbvcq.supabase.co/functions/v1/submit-order';
            fetch(supabaseFunctionURL + out_str)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = 'checkout.html';
                    } else {
                        document.getElementById('output').innerText = 'Error: ' + data.error;
                        document.getElementById('submitBtn').textContent = 'Submit Order';
                        document.getElementById('submitBtn').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('output').innerText = 'Network error. Please try again.';
                    document.getElementById('submitBtn').textContent = 'Submit Order';
                    document.getElementById('submitBtn').disabled = false;
                });
        }
    </script>
</body>

</html>