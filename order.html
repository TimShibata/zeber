<!DOCTYPE html>
<html lang="en">

<script>
    function includeHTML() {
        var z, i, elmnt, file, xhttp;
        /*loop through a collection of all HTML elements:*/
        z = document.getElementsByTagName("*");
        for (i = 0; i < z.length; i++) {
            elmnt = z[i];
            /*search for elements with a certain attribute:*/
            file = elmnt.getAttribute("nav-bar");
            if (file) {
                /*make an HTTP request using the attribute value as the file name:*/
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) { elmnt.innerHTML = this.responseText; }
                        if (this.status == 404) { elmnt.innerHTML = "Page not found."; }
                        /*remove the attribute, and call this function once more:*/
                        elmnt.removeAttribute("nav-bar");
                        includeHTML();
                    }
                }
                xhttp.open("GET", file, true);
                xhttp.send();
                /*exit the function:*/
                return;
            }
        }
    };
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zeber</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css?v=2">
</head>

<body>
    <div nav-bar="nav_bar.html"></div>

    <h1 class="page-title">Hours of operation 4:30 – 7:00</h1>

    <div class="content-container">
        <div id="menuItems">
            <div class="menu-item" data-price="10">
                <img class="item-img" src="zeber-bottle-cropped-01.png" alt="Zeber beer bottle">
                <div class="item-info">
                    <span class="item-name">Beer Delivery</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num1', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num1">0</span>
                    <input type="hidden" id="num1" value="0">
                    <button class="stepper-btn" onclick="adjust('num1', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="10">
                <img class="item-img" src="order_files/chips_and_guacamole.jpg" alt="chips">
                <div class="item-info">
                    <span class="item-name">Chips</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num2', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num2">0</span>
                    <input type="hidden" id="num2" value="0">
                    <button class="stepper-btn" onclick="adjust('num2', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="5">
                <img class="item-img" src="order_files/chair.jpg" alt="folding chair">
                <div class="item-info">
                    <span class="item-name">Chair Moving Services</span>
                    <span class="item-price">5&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num3', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num3">0</span>
                    <input type="hidden" id="num3" value="0">
                    <button class="stepper-btn" onclick="adjust('num3', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="15">
                <img class="item-img" src="order_files/hammock.jpeg" alt="hammock">
                <div class="item-info">
                    <span class="item-name">Hammock Rental</span>
                    <span class="item-price">15&#162; / hr</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num4', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num4">0</span>
                    <input type="hidden" id="num4" value="0">
                    <button class="stepper-btn" onclick="adjust('num4', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="10">
                <img class="item-img" src="order_files/redball_poster.jpg" alt="redball entertainment">
                <div class="item-info">
                    <span class="item-name">Redball Tickets</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num5', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num5">0</span>
                    <input type="hidden" id="num5" value="0">
                    <button class="stepper-btn" onclick="adjust('num5', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="10">
                <img class="item-img" src="order_files/trophy-on-field-under-stadium-lights-at-night-photo.jpg" alt="redball tournament trophy">
                <div class="item-info">
                    <span class="item-name">Redball Tournament</span>
                    <span class="item-price">10&#162;</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num6', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num6">0</span>
                    <input type="hidden" id="num6" value="0">
                    <button class="stepper-btn" onclick="adjust('num6', 1)">+</button>
                </div>
            </div>

            <div class="menu-item" data-price="1500">
                <img class="item-img" src="order_files/zeber-shirt-model.png" alt="Zeber t-shirt">
                <div class="item-info">
                    <span class="item-name">T-Shirt</span>
                    <span class="item-price">$15.00</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num7', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num7">0</span>
                    <input type="hidden" id="num7" value="0">
                    <button class="stepper-btn" onclick="adjust('num7', 1)">+</button>
                </div>
            </div>
            <div class="menu-item" data-price="15">
                <img class="item-img" src="order_files/cowbell.png" alt="Cowbell">
                <div class="item-info">
                    <span class="item-name">Cowbell Rental</span>
                    <span class="item-price">15&#162; / hr</span>
                </div>
                <div class="item-stepper">
                    <button class="stepper-btn" onclick="adjust('num8', -1)">&#x2212;</button>
                    <span class="stepper-qty" id="qty_num8">0</span>
                    <input type="hidden" id="num8" value="0">
                    <button class="stepper-btn" onclick="adjust('num8', 1)">+</button>
                </div>
            </div>        </div>
    </div>

    <!-- Sticky order footer -->
    <div class="order-footer">
        <select id="personID" class="person-select">
            <option value="Grandpa">Grandpa</option>
            <option value="Grandma">Grandma</option>
            <option value="Jess">Jess</option>
            <option value="Mario">Mario</option>
            <option value="Dad">Dad</option>
            <option value="Mom">Mom</option>
            <option value="James">James</option>
            <option value="Jaclyn">Jaclyn</option>
            <option value="Joel">Joel</option>
            <option value="Jenn">Jenn</option>
            <option value="Miss Maureen">Miss Maureen</option>
            <option value="Mr. Kevin">Mr. Kevin</option>
            <option value="Miss Andread">Miss Andread</option>
            <option value="Mr. Brendan">Mr. Brendan</option>
            <option value="Miss Hanna">Miss Hanna</option>
            <option value="Mr Tim">Mr Tim</option>
            <option value="Miss Ren">Miss Ren</option>
            <option value="Mr. Mark C.">Mr. Mark C.</option>
            <option value="Miss Erin">Miss Erin</option>
            <option value="Mr. Mark A.">Mr. Mark A.</option>
            <option value="Miss Betsy">Miss Betsy</option>
            <option value="Mr. Bryan">Mr. Bryan</option>
            <option value="Miss Arwen">Miss Arwen</option>
            <option value="Miss Jenn">Miss Jenn</option>
        </select>
        <span class="footer-total" id="totalDisplay">0&#162;</span>
        <button id="submitBtn" class="submit-btn" onclick="submitOrder()">Submit Order</button>
    </div>

    <div id="output"></div>
    <script>
        includeHTML();

        function setCookie(name, value) {
            document.cookie = `${name}=${encodeURIComponent(value)}; path=/`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            for (const cookie of cookies) {
                const [cookieName, cookieValue] = cookie.split('=');
                if (cookieName === name) return decodeURIComponent(cookieValue || '');
            }
            return null;
        }

        window.onload = function () {
            const lastPersonID = getCookie('personID');
            if (lastPersonID) document.getElementById('personID').value = lastPersonID;
        };
        window.onload();

        function adjust(id, delta) {
            var input = document.getElementById(id);
            var newVal = Math.max(0, parseInt(input.value) + delta);
            input.value = newVal;
            document.getElementById('qty_' + id).textContent = newVal;
            input.closest('.menu-item').classList.toggle('selected', newVal > 0);
            updateTotal();
        }

        function updateTotal() {
            var total = 0;
            document.querySelectorAll('#menuItems .menu-item').forEach(function (item) {
                var qty = parseInt(item.querySelector('input[type="hidden"]').value);
                var price = parseInt(item.dataset.price);
                total += qty * price;
            });
            var display = document.getElementById('totalDisplay');
            if (total === 0) {
                display.textContent = '0\u00A2';
            } else if (total < 100) {
                display.textContent = total + '\u00A2';
            } else {
                display.textContent = '$' + (total / 100).toFixed(2);
            }
        }

        function submitOrder() {
            setCookie('personID', document.getElementById('personID').value);
            document.getElementById('output').innerText = '';
            document.getElementById('submitBtn').textContent = 'Submitting…';
            document.getElementById('submitBtn').disabled = true;

            var inputs = document.querySelectorAll('#menuItems input[type="hidden"]');
            var out_str = '?';
            for (var i = 0; i < inputs.length; i++) {
                out_str += 'item' + (i + 1) + '=' + inputs[i].value + '&';
            }
            out_str += 'person=' + encodeURIComponent(document.getElementById('personID').value);

            var supabaseFunctionURL = 'https://dpsmpuigeadjpjodbvcq.supabase.co/functions/v1/submit-order';
            fetch(supabaseFunctionURL + out_str)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = 'checkout.html';
                    } else {
                        document.getElementById('output').innerText = 'Error: ' + data.error;
                        document.getElementById('submitBtn').textContent = 'Submit Order';
                        document.getElementById('submitBtn').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('output').innerText = 'Network error. Please try again.';
                    document.getElementById('submitBtn').textContent = 'Submit Order';
                    document.getElementById('submitBtn').disabled = false;
                });
        }
    </script>
</body>

</html>